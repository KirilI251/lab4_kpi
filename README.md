# Лабораторна робота №4
з дисципліни: «Компоненти програмної інженерії» 

на тему: «Тестування бізнес-логіки ASP.NET Web API за допомогою xUnit та Moq» 

Варіант №4

Виконав студент

IІІ курсу
групи КП-32

Підгірний Кирило

---

## Тестування сервісів

Тестовий проєкт `SmartHomeTests` містить повний набір юніт-тестів, що покривають усю бізнес-логіку обох сервісів.

### 1. DeviceServiceTests (Тести для `DeviceService`)

Цей клас тестів перевіряє логіку, пов'язану з керуванням пристроями та отриманням їх поточного стану.

* **`Метод ToggleDevice`**
    * **Успішне ввімкнення:** Перевірено, що метод повертає `true` (`Assert.True`) і що стан пристрою зберігається в репозиторії (`Verify(..., Times.Exactly(1))`).
    * **Успішне вимкнення:** Перевірено, що метод повертає `false` (`Assert.False`) і що репозиторій був викликаний (`Verify(..., Times.Once)`).
    * **Неіснуючий пристрій:** Перевірено, що сервіс коректно генерує виняток `ArgumentException` (`Assert.Throws`), якщо пристрій не знайдено, і що метод `Update` *не* викликається (`Verify(..., Times.Never)`).
    * **Перевірка зміни стану:** Додано тест, який перевіряє, що кінцевий стан пристрою `IsOn` *не дорівнює* початковому стану (`Assert.NotEqual`).

* **`Метод GetActiveDevices`**
    * **Фільтрація активних:** Перевірено, що список, який повертається, не є `null` (`Assert.NotNull`), містить коректну кількість пристроїв (`Assert.Equal`) і містить *лише* увімкнений пристрій (`Assert.Contains`).
    * **Відсутність активних:** Перевірено, що метод повертає порожню колекцію (`Assert.Empty`), якщо всі пристрої вимкнені.

### 2. EnergyMonitorServiceTests (Тести для `EnergyMonitorService`)

Цей клас тестів перевіряє складнішу бізнес-логіку моніторингу енергоспоживання, перевірки лімітів та відправки сповіщень.

* **`Метод CalculateCurrentUsageKwh`**
    * **Коректний розрахунок:** Перевірено правильність розрахунку (сума `PowerUsageWatts` увімкнених пристроїв / 1000.0) за допомогою `Assert.Equal`.
    * **Параметризований тест:** Використано `[Theory]` та `[InlineData]` для перевірки кількох сценаріїв, де всі пристрої вимкнені. У всіх цих випадках результат має бути `0.0`.

* **`Метод CheckForOverload`**
    * **Сповіщення про перевантаження:** Перевірено, що якщо споживання (`usage`) перевищує ліміт (`plan.DailyLimitKwh`), сервіс сповіщень *викликається* (`Verify(..., Times.Once)`).
    * **Відсутність перевантаження:** Перевірено, що якщо споживання знаходиться в межах ліміту, сервіс сповіщень *не викликається* (`Verify(..., Times.Never)`).
    * **Зміст сповіщення:** Перевірено, що при перевантаженні метод `SendAlert` викликається з повідомленням, яке містить текст "Overload detected" (`It.Is<string>(predicate)`).

* **`Метод UpdateEnergyLimit`**
    * **Коректне оновлення:** Перевірено, що метод `_plans.UpdatePlan` викликається з об'єктом `EnergyPlan`, у якого `DailyLimitKwh` дорівнює новому, переданому значенню (`It.Is<EnergyPlan>(predicate)`).
    * **Факт виклику:** Додано окремий тест, який підтверджує, що `UpdatePlan` викликається з *будь-яким* об'єктом `EnergyPlan` (`It.IsAny<EnergyPlan>()`).

## Реалізовані типи перевірок

Відповідно до завдання, проєкт реалізує 15 різних типів перевірок з xUnit та Moq:

* `[Theory] / [InlineData]` — для параметризованих тестів.
* `Assert.Equal` / `Assert.NotEqual` — для порівняння значень.
* `Assert.True` / `Assert.False` — для булевих перевірок.
* `Assert.NotNull` — для перевірки, що об'єкт не `null`.
* `Assert.Contains` — для перевірки, що колекція містить елемент.
* `Assert.Empty` — для перевірки на порожню колекцію.
* `Assert.Throws` — для перевірки винятків.
* `Verify()` (представлений як `Times.Once`) — перевірка виклику методу.
* `Verify(..., Times.Never)` — перевірка, що метод не викликано.
* `Verify(..., Times.Exactly(n))` — перевірка точної кількості викликів.
* `Verify(..., Times.AtLeastOnce)` — (категорія, покрита `Times.Once`) гнучка перевірка виклику.
* `It.Is(predicate)` (представлений як `It.Is<T>`) — для перевірки аргументу, що відповідає предикату.
* `It.IsAny()` — для імітації аргументу будь-якого (не `null`) значення. 